const AES_KEY = 'fn+Qnu0P5I6alrqUYAU2ToZQt5MAjl+RSA0nOPtR9R8=';
const AES_IV = 'kBNmAwfcb3L2W/IvcBbjbA==';
const PRIVATE_KEY = 'MIIJQwIBADANBgkqhkiG9w0BAQEFAASCCS0wggkpAgEAAoICAQC3FJJbj33wwoN2DO3rdhNDRH7CriwYerVw/1yeKaKE2ffqvvHrLTjyB4sIMM4hDmvoQO45SRs3jcI9TkKx1+yGf6BVbmLeEGL9NgueHUxGMSYUi3CX8vfafJRAQFf0oo63RUGLbiDbpdiHZGJH2nbtXRz6mtfpqAaYyn0ODtw01WNoa+xcbWQwOdeSfhP3BTmZE/Dx45Tw/ZD0y5FLleu18MWg020Bkfxm+RMKzvSpqMG18hxeK3t7pIqqlRDwxmhxmDlM64f8kExDB5bexhg1yZbO1yu90SoWNeQvoXgCeYcIvxCiQifpueYSaCK0cmgjKOfpXWEcKOmecKUJ731Dscw28X8fPjUrvL9OdB24ZTZbbeA0Saf2yMX/tGcnsiH0eGZ2n68IWNn81gIQ/yNKa1lPgLyjRn2pISegiXdfoWBOW6nhHQJkeMlRsIy+J4RPb95HwlM6EZosRgJ2+pJRfFyQwKStOI4NYCbBjEMlkxeWjXQeIEMfc0Ke3ObFHlSkQs9hcYezgeSCVEXaHhTXwpIAcdZhIBmQroFH80SAWmxWrv146o80QlTgQx8l7rzmpYrnITLWQmMgRTkMA08/sthIiau3KKZL8pUmIA8tPlLMRXCTZe/6qEogcIFFgg7g5H6vlQxTXcNwKCkavnm1hx4w+Qn2U3MqMbuTIPUiWwIDAQABAoICAFsBsV0tP4PqFRIeDDijGaEzD7XzgXzrpnzUm3QNqzlR5nB82WG3uZpqEH0SUazR7+bkO+cjBZIAeCEkYXfpJyyWjZtaA3Bygdpvvqeq1asArHbC98W4o+cqTUGBGpfDJKFKnnHSXSgCUVfAGTCxkrOcORcD2LdP7HOQGEjgLyteNYuHNledkxN79UJfRMpigQasiHWdVQDUcvWUqZWCoUhwNrUi1AlXSbngL0yMoschWaV5hAt1nuzP1pREBEdDwVBSRI2NeSwdiKM7Rw5XN1qpajtIb3hsXHjs8hCROcg1I+A/peOach+3ZnwY4sODKWvs3hc9cVPfrH2zbf652zBvRxSva55aqmYmrKZmxbUhL0RJYqEK7NDM8o1UWdMDoCXzlAZWkL+WL4tU8VXvNMn5+QCIAjnA52NnI2nbGrRNxcHu+WsDYgJIw4KhhwZFBU6/N3sQoXPjh9jbR7P1rs42cyZj2ojTODBPO2+ByhGqVGW0xjcpla2k8NGcO47HOESTRFbkppLhE6bDR1083ItPvJBiZXAZWLo6wKVw6KevLnv6awRQkRLm5W9C/QfhJ9xmMGVRMpELL12vKZ9YOz6rWNgWWU8cv1F5fZLN+2dMrRjSM3ypnnBDdJwFRoPZCkJvo5zarEuH/3r0sobzUQVh7g/Vi7MynaQrDtV2exhVAoIBAQDkt5D58XrOWk0HZH0A0QVkPT7TDezwmzRJE2FT/oybDJMClKaQUiaWiTVQyaaotzDwe1FAEr4sCOiciIG6P3qq1W/zNltVl73qVUn4St+5m6aYCXhDGznWJ7uxnCZMtYI6B8UDydxPrzHF3s1Ohhouw5K6f1U23HoerL8CflFal/DwFr8Fit8EO8MQqwjJzKJnGql0eL+3xYjseHoLLFP2q5zBM9bAQ+2GuGV8ZyCZofvGSlTXDHS3JgVP5Sqv4R/wOLPug0XGPZH93Xc4FUhEP8uOIV9G1uvIuW3ej9zSHvHGBZm4WWIME1GBrIysVysITUAxzTn1h5lmiixk79NlAoIBAQDM62CeV0L0NFY6FcGDvPJBUxeUCVlz4vvfj5WuqcNVE1E8OCKC5KaERzA2DkLYkFcM+n2oQY5K/7a3++3ydjnqBRvsimfcSasiuRu8+ZQ/ak9Ddoqign0NPzWPTp3uD9Nk+aFgzfhvL7rnxsyLNTBKcl7uNH7blmf0ADP/iV+9YSV5ipSPYJDdtqRDj39y+FEcNXGtKZ8DMdzBEp8hXjh0CJ6bUeiD07/oAuLey0Q9WxdFOsCd6UYd6pVngTHAayaIhRRLz48to1O59CFHFQXJv0kgexy+F3vD1q/IBdLSyZYYLqAOzTYBU37kXa7UM2w42++dSjz5sbkj11SkdyK/AoIBAQDXCH8VfyOmvt+NA71C90HKbIqUg5Mw47rUuZPYFIq9e6T72CaBqbr97SJjQjOejB1G+6n4Q6boX7fS88SEBwqdcu4+C+zzHCdCGc3h0wNkziJi7wRSk1ZdMh4VbmnT1RMK3CMu3Kp1gJGbJ05/dTVIojdhgDXtznxCOsea4Ig8VH4CPGB8JYRnxogvM56fm/VUWozXJG+bp+yD5wFXX+XRFKfcPZC6UyMOdm9z9sF/r/u3Akuho+RYDTcRVrQ7h70vbSA+Ls17BIgt1fowkFHRWOlYR6f8QjSME0po5XkHVHCbbMiJuf+kusT21fOsVIfw1jB0oi7L2SEwdtgmThTBAoIBAQCJZZDE2jF0V9sw2wGDeR7dmf8HLTWjNCA5h6aPFBh6ZJdlTyYkqXbU3n5+4BUF69HSS+oQ9NOZiddTiUHD/m1acc6FTU/SLjrm70Kf9J/n3ToEO+k8iU2bojQhQE84HbhZzd7cb34R3ujtGyhudl1IrWLlSKF+TlypB7HVtqBQ9GASHE77y32Wiy2cdwy3Y7POvC7aMjwCAl7HvdqgnvIvKtBdyA+kxEe6IqVHSPcaRIdXzcr0lkKDMJS4b7GSGMYfZ0tygVq4+PfciMn/RSM6YF2Bv8pH0qsTZlE6Rl1TJALVd/2trv506Sz9parhcRExFpaU2gAEU5uVYn3IQHE1AoIBABOqWQsy6XZuAlTgyaFGxzEPUNBhiq5v+mi08w8/Ze97vGoILR/nsdvdy99ej7dNeE57Jx4gVxN9Ibezav5N6EODipQb8erg5APQyoNMeERPrBAptDFr799RBYLA3sWapPYlKfPNmKk8UOPUp9at30bFbHu1C/eNlkgzBGK5LNOpHV0+MmnoQwasNfajWNg8zKGeeJc1JLLPZq+ZEN7V0DBjiyEiPqgvVjThaWZM6ISmMsoth9iuxD1/7MdE7Y74FbIzMI7BaFDu7uImbCxN51KfN/q1J5emoo5XSUjJlOZFoWr0kdoN+xQbE6EaqU7nBATn3aAXyoI/CShZtopu63g=';
const PUBLIC_KEY = 'MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAtxSSW4998MKDdgzt63YTQ0R+wq4sGHq1cP9cnimihNn36r7x6y048geLCDDOIQ5r6EDuOUkbN43CPU5Csdfshn+gVW5i3hBi/TYLnh1MRjEmFItwl/L32nyUQEBX9KKOt0VBi24g26XYh2RiR9p27V0c+prX6agGmMp9Dg7cNNVjaGvsXG1kMDnXkn4T9wU5mRPw8eOU8P2Q9MuRS5XrtfDFoNNtAZH8ZvkTCs70qajBtfIcXit7e6SKqpUQ8MZocZg5TOuH/JBMQweW3sYYNcmWztcrvdEqFjXkL6F4AnmHCL8QokIn6bnmEmgitHJoIyjn6V1hHCjpnnClCe99Q7HMNvF/Hz41K7y/TnQduGU2W23gNEmn9sjF/7RnJ7Ih9Hhmdp+vCFjZ/NYCEP8jSmtZT4C8o0Z9qSEnoIl3X6FgTlup4R0CZHjJUbCMvieET2/eR8JTOhGaLEYCdvqSUXxckMCkrTiODWAmwYxDJZMXlo10HiBDH3NCntzmxR5UpELPYXGHs4HkglRF2h4U18KSAHHWYSAZkK6BR/NEgFpsVq79eOqPNEJU4EMfJe685qWK5yEy1kJjIEU5DANPP7LYSImrtyimS/KVJiAPLT5SzEVwk2Xv+qhKIHCBRYIO4OR+r5UMU13DcCgpGr55tYceMPkJ9lNzKjG7kyD1IlsCAwEAAQ==';
const WRAPPED_KEY = 'rnAIsFLrclZ1lnleC5tG/UM+DjDlcraaKEermodeCJJw32tyn4gFARDnL6Am79bmV/XSgf59lfeV/lqepg+e75u9dPBQZoFWEv2bFMhOmzb7VW1GWCMJc03wa9MdIzAh7VA32e4CVcFOsdbD17oEIkty7oBujgk+jqczGS6rMCaWyqXc0b2ctirPypL/dNmlfPurigVhEQYt09Tu0unFvtMh1+5do2Zmq8ZZqvU2VbKZ7dstvyjrJfrYjTn0gRTS7JqP/UqCjuSBsduDwIHd4joRUSxsul+1hlr0+6c93ZxD2BZPqzX/WlcUoiSnjCVFprEkbinq0Zm9lmRMUDTkVuXeB0XuNJPA4Xf0O6oTJkLT3d/l5J27a4NlSVp/YDemUQLyBq+KcuRsdB8Ha2Ba5vHbquuz6SJN3MQvW1nvm4K4n22YenOd4/jMu0BPeVGLLLvwJqRSayqPopbOs7IF3AtDvxDuLisQ2iY0wXqpuAR/LzJtttEukdu17FUBh+CvH+SERRcwQON5rCMW6PNm1NUo3ZUsgSHvTcVllcfm3/a1T5h+LCDQYsGDP9mf6wJYuu+lpWpfsjMAnkezKRCBo1OttwyU68ou3fk2Ji8MRZo8r6CPKLsBWPfUkqG5Oi8X8gUZTZc26MAj1q1lz4cyZCjE1dfynIyE1KmZsrF16T0=';

describe('encode', () => {
    describe('base64', () => {
        const input = 'SGVsbG8gd29ybGQh';
        const output = new Uint8Array([
            72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 33
        ]);
        it('toBuffer', () => {
            const buffer = encode.base64.toBuffer(input)
            expect(new Uint8Array(buffer)).toEqual(output);
        });
        it('fromBuffer', () => {
            expect(encode.base64.fromBuffer(output)).toEqual(input);
        });
    });
    describe('hex', () => {
        const input = '48656c6c6f20776f726c6421';
        const output = new Uint8Array([
            72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 33
        ]);
        it('toBuffer', () => {
            const buffer = encode.hex.toBuffer(input)
            expect(new Uint8Array(buffer)).toEqual(output);
        });
        it('fromBuffer', () => {
            expect(encode.hex.fromBuffer(output)).toEqual(input);
        });
    });
    describe('string', () => {
        const input = 'Hello world!';
        const output = new Uint8Array([
            72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 33
        ]);
        it('toBuffer', () => {
            const buffer = encode.string.toBuffer(input)
            expect(new Uint8Array(buffer)).toEqual(output);
        });
        it('fromBuffer', () => {
            expect(encode.string.fromBuffer(output)).toEqual(input);
        });
    });
    describe('utf8', () => {
        const input = 'Hello, 世界';
        const output = new Uint8Array([
            72, 101, 108, 108, 111, 44, 32, 228, 184, 150, 231, 149, 140
        ]);
        it('toBuffer', () => {
            const buffer = encode.utf8.toBuffer(input)
            expect(new Uint8Array(buffer)).toEqual(output);
        });
        it('fromBuffer', () => {
            expect(encode.utf8.fromBuffer(output)).toEqual(input);
        });
    });
});

describe('SecretKey', () => {
    let key;
    beforeAll(done => {
        const buffer = encode.base64.toBuffer(AES_KEY);
        SecretKey.import(buffer).then(k => {
            key = k;
            done();
        });
    });
    it('import', () => {
        expect(key).toEqual(jasmine.any(SecretKey));
    });
    it('export', done => {
        key.export().then(raw => {
            expect(encode.base64.fromBuffer(raw)).toEqual(AES_KEY);
            done();
        });
    });
    it('generate', done => {
        SecretKey.generate().then(k => {
            expect(k).toEqual(jasmine.any(SecretKey));
            done();
        });
    });
    it('encrypt', done => {
        const buffer = encode.string.toBuffer('Hello world!');
        const iv = encode.base64.toBuffer(AES_IV);
        key.encrypt(iv, buffer).then(ciphertext => {
            const cipher64 = encode.base64.fromBuffer(ciphertext);
            expect(cipher64).toEqual('SjBvLNOlEPxpZSu0PIzjPg==');
            done();
        });
    });
    it('decrypt', done => {
        const buffer = encode.base64.toBuffer('SjBvLNOlEPxpZSu0PIzjPg==');
        const iv = encode.base64.toBuffer(AES_IV);
        key.decrypt(iv, buffer).then(plaintext => {
            const string = encode.string.fromBuffer(plaintext);
            expect(string).toEqual('Hello world!');
            done();
        });
    });
});

describe('PrivateKey', () => {
    let key;
    beforeAll(done => {
        const buffer = encode.base64.toBuffer(PRIVATE_KEY);
        PrivateKey.import(buffer).then(k => {
            key = k;
            done();
        });
    });
    it('import', () => {
        expect(key).toEqual(jasmine.any(PrivateKey));
    });
    it('export', done => {
        key.export().then(buffer => {
            const base64 = encode.base64.fromBuffer(buffer);
            expect(base64).toEqual(PRIVATE_KEY);
            done();
        });
    });
    it('getPublicKey', done => {
        key.getPublicKey().then(pub => {
            expect(pub).toEqual(jasmine.any(PublicKey));
            done();
        });
    });
    it('unwrapKey', done => {
        const buffer = encode.base64.toBuffer(WRAPPED_KEY);
        key.unwrapKey(buffer).then(aesKey => {
            aesKey.export().then(raw => {
                expect(encode.base64.fromBuffer(raw)).toEqual(AES_KEY);
                done();
            });
        });
    });
});
